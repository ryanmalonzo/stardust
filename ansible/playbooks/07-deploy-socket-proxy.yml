---
# Create Docker network, volume, and deploy socket proxy stack to Docker VM

- name: Setup and deploy socket proxy to Docker VM
  hosts: docker
  become: true
  remote_user: stardust
  vars:
    dest_compose_path: /home/stardust/socket-proxy/compose.yaml
  tasks:
    - name: Create Docker network for socket proxy
      community.docker.docker_network:
        name: socket-proxy
        state: present
        driver: bridge

    - name: Create Docker volume for socket proxy
      community.docker.docker_volume:
        name: socket-proxy
        state: present

    - name: Ensure socket-proxy directory exists
      ansible.builtin.file:
        path: /home/stardust/socket-proxy
        state: directory
        owner: stardust
        group: stardust
        mode: "0755"

    - name: Copy socket proxy Docker Compose file
      ansible.builtin.copy:
        src: ../docker/socket-proxy.yaml
        dest: "{{ dest_compose_path }}"
        owner: stardust
        group: stardust
        mode: "0600"

    - name: Deploy socket proxy stack with Docker Compose v2
      community.docker.docker_compose_v2:
        project_src: /home/stardust/socket-proxy
        files:
          - compose.yaml
        state: present
